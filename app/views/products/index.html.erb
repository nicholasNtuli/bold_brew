<div class="container-custom py-12 px-4">
  <div class="flex items-center justify-between mb-8">
    <div class="flex sm:hidden space-x-2">
      <div class="relative">
        <button id="category-menu-btn" class="flex items-center px-4 py-2 border rounded-full text-brew-black hover:bg-neutral-100 transition-colors">
          Categories
          <svg class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <div id="category-menu" class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden z-10">
          <div class="py-1">
            <%= link_to 'All', products_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
            <% @categories.each do |category| %>
              <%= link_to category.name, products_path(category: category.name), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="hidden sm:flex space-x-2">
      <%= link_to 'All', products_path,
            class: "px-4 py-2 rounded-full #{params[:category].blank? ? 'bg-gray-200 text-gray-700' : 'text-black'}" %>
      <% @categories.each do |category| %>
        <%= link_to category.name, products_path(category: category.name),
              class: "px-4 py-2 rounded-full #{params[:category] == category.name ? 'bg-gray-200 text-gray-700' : 'text-black'}" %>
      <% end %>
    </div>

    <div class="relative">
      <button id="sort-menu-btn" class="flex items-center px-4 py-2 border rounded-full text-brew-black hover:bg-neutral-100 transition-colors">
        Sort by
        <svg class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
      </button>
      <div id="sort-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden z-10">
        <div class="py-1">
          <%= link_to 'Name (A-Z)', products_path(params.permit(:category).merge(q: { s: 'name asc' })), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
          <%= link_to 'Name (Z-A)', products_path(params.permit(:category).merge(q: { s: 'name desc' })), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
          <%= link_to 'Price (Low to High)', products_path(params.permit(:category).merge(q: { s: 'price_cents asc' })), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
          <%= link_to 'Price (High to Low)', products_path(params.permit(:category).merge(q: { s: 'price_cents desc' })), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
        </div>
      </div>
    </div>
  </div>

  <% if @products.any? %>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8">
      <% @products.each do |product| %>
        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow flex flex-col justify-between">
          <%= link_to product, class: "flex flex-col h-full" do %>
            <% if product.images.attached? %>
              <%= image_tag product.images.first, class: "w-full h-64 object-cover", alt: "No image available" %>
            <% else %>
              <%= image_tag "placeholder.png", class: "w-full h-64 object-cover", alt: "No image available" %>
            <% end %>

            <div class="p-4 flex flex-col h-full">
              <div class="flex-grow">
                <h2 class="text-xl font-bold text-brew-dark mb-2">
                  <%= product.name %>
                </h2>
                <p class="text-neutral-600 mb-4">
                  <% first_sentence = product.description.split('.').first.strip %>
                  <% if first_sentence.present? && product.description.length > first_sentence.length %>
                    <%= first_sentence + "." %>
                  <% else %>
                    <%= product.description %>
                  <% end %>
                </p>
              </div>
        
              <div class="mt-auto">
                <p class="font-bold text-lg text-brew-brown">
                  <%= number_to_currency(product.price_cents / 100.0, unit: 'R') %>
                </p>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>

    <div class="text-center py-16">
      <% if @category.present? %>
        <%= image_tag('coffee-logo.png', alt: 'Coffee Logo', class: 'mx-auto mb-4', width: '200', height: '200') %>
        <h2 class="text-2xl font-bold text-brew-dark mb-4">
          <%= @category.name %> coming soon!
        </h2>
        <p class="text-neutral-600">We’re brewing up something new in this category. Check back later!</p>
      <% else %>
        <h2 class="text-2xl font-bold text-brew-dark mb-4">No products found.</h2>
        <p class="text-neutral-600">We’re brewing up something new. Please check back later!</p>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // For sorting dropdown
    const sortBtn = document.getElementById('sort-menu-btn');
    const sortMenu = document.getElementById('sort-menu');

    sortBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      sortMenu.classList.toggle('hidden');
    });

    // For new category dropdown
    const categoryBtn = document.getElementById('category-menu-btn');
    const categoryMenu = document.getElementById('category-menu');

    if (categoryBtn) {
      categoryBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        categoryMenu.classList.toggle('hidden');
      });
    }

    // Close menus if the user clicks outside of them
    document.addEventListener('click', (event) => {
      if (sortMenu && !sortMenu.contains(event.target) && !sortBtn.contains(event.target)) {
        sortMenu.classList.add('hidden');
      }
      if (categoryMenu && !categoryMenu.contains(event.target) && !categoryBtn.contains(event.target)) {
        categoryMenu.classList.add('hidden');
      }
    });
  });
</script>