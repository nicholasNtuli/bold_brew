<header class="sticky top-0 left-0 w-full bg-white shadow-sm z-50">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <div class="flex items-center">
      <%= link_to root_path, class: "flex items-center space-x-2" do %>
        <span class="text-brew-brown text-2xl font-bold font-bebas">Bold Brew</span>
      <% end %>
    </div>
    
    <nav class="hidden md:flex space-x-6 lg:space-x-8 text-sm font-medium items-center">
      <%= link_to "Home", root_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(root_path)}" %>
      <%= link_to "Shop", products_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(products_path)}" %>
      <%= link_to "About", about_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(about_path)}" %>
      <%= link_to "Contact", contact_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(contact_path)}" %>
      
      <% if user_signed_in? %>
        <% if current_user.admin? %>
          <%= link_to "Products", admin_products_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(admin_products_path)}" %>
        <% end %>
      <% end %>
    </nav>
    
    <div class="flex items-center space-x-4 flex-grow justify-end md:flex-grow-0">

      <div class="hidden lg:flex relative">
        <button id="desktop-search-toggle" class="text-brew-dark hover:text-brew-brown transition-colors duration-200">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>

        <div id="desktop-search" class="absolute top-full right-0 w-[300px] mt-2 hidden">
          <%= form_with url: search_path, method: :get, local: true, id: "search-form", class: "relative w-full" do |f| %>
            <%= f.text_field :q, 
                  placeholder: "Search products...", 
                  value: params[:q],
                  class: "w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-brew-brown focus:border-transparent",
                  id: "search-input",
                  autocomplete: "off" %>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
          <% end %>
        </div>
      </div>
    
      <button id="mobile-search-toggle" class="lg:hidden text-brew-dark hover:text-brew-brown transition-colors duration-200">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </button>

      <%= link_to cart_path, class: "relative text-brew-dark hover:text-brew-brown transition-colors duration-200" do %>
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.182 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
      <% end %>

      <% if user_signed_in? %>
        <div class="relative group hidden md:flex">
          <button class="flex items-center text-sm font-medium text-brew-dark hover:text-brew-brown focus:outline-none">
            <% if current_user.profile_picture.attached? %>
              <%= image_tag current_user.profile_picture.variant(resize_to_fill: [24, 24]), class: "h-6 w-6 rounded-full mr-2" %>
            <% else %>
              <div class="h-6 w-6 rounded-full mr-2 bg-gray-200 flex items-center justify-center text-gray-500">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/>
                </svg>
              </div>
            <% end %>
            <%= current_user.username.presence || current_user.email.split('@').first %>
            <svg class="ml-2 h-4 w-4 transition-transform duration-200 group-hover:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden group-hover:block transition-all duration-300 transform origin-top-right scale-95 opacity-0 group-hover:scale-100 group-hover:opacity-100">
            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
              <%= link_to 'My Profile', profile_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
              <%= link_to 'My Orders', orders_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
              <div class="border-t border-gray-100 my-1"></div>
              <%= button_to 'Sign out', destroy_user_session_path, method: :delete, data: { turbo_confirm: "Are you sure you want to sign out?" }, class: "w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
            </div>
          </div>
        </div>
      <% else %>
        <div class="hidden md:flex items-center space-x-2">
          <%= link_to "Sign In", new_user_session_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200" %>
        </div>
      <% end %>

      <button id="mobile-menu-button" type="button" class="md:hidden text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-brew-brown" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg id="menu-open-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="menu-close-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <div id="mobile-search" class="lg:hidden px-4 pb-4 hidden">
    <%= form_with url: search_path, method: :get, local: true, class: "relative" do |f| %>
      <%= f.text_field :q, 
            placeholder: "Search products...", 
            value: params[:q],
            class: "w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-brew-brown focus:border-transparent" %>
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
    <% end %>
  </div>

  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-4 pt-4 pb-3 space-y-2 bg-white border-t border-gray-200 shadow-lg">
      <% if user_signed_in? %>
        <div class="flex items-center space-x-3 mb-4">
          <% if current_user.profile_picture.attached? %>
            <%= image_tag current_user.profile_picture.variant(resize_to_fill: [40, 40]), class: "h-10 w-10 rounded-full" %>
          <% else %>
            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/>
              </svg>
            </div>
          <% end %>
          <span class="text-brew-dark font-semibold">
            <%= current_user.username.presence || current_user.email.split('@').first %>
          </span>
        </div>
      <% end %>

      <%= link_to "Home", root_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(root_path)}" %>
      <%= link_to "Shop", products_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(products_path)}" %>
      <%= link_to "About", about_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(about_path)}" %>
      <%= link_to "Contact", contact_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(contact_path)}" %>

      <% if user_signed_in? %>
        <% if current_user.admin? %>
          <%= link_to "Products", admin_products_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(admin_products_path)}" %>
        <% end %>
        <%= link_to "My Profile", profile_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(profile_path)}" %>
        <%= link_to "My Orders", orders_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4 #{'bg-gray-100' if current_page?(orders_path)}" %>
        <%= button_to "Sign out", destroy_user_session_path, method: :delete, data: { turbo_confirm: "Are you sure you want to sign out?" }, class: "w-full text-left block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4" %>
      <% else %>
        <%= link_to "Sign In", new_user_session_path, class: "block text-brew-dark hover:text-brew-brown transition-colors duration-200 rounded-full py-2 px-4" %>
        <%= link_to "Sign Up", new_user_registration_path, class: "block text-white bg-brew-brown hover:bg-brew-dark transition-colors duration-200 rounded-full py-2 px-4" %>
      <% end %>
    </div>
  </div>
</header>

<script>
  // Search functionality
  let searchTimeout;
  
  function initSearch() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');
    
    if (!searchInput || !searchResults || !searchResultsContent) return;
    
    // Real-time search as user types
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
      }
      
      searchTimeout = setTimeout(() => {
        fetch(`/search.json?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            if (data.products.length > 0) {
              let html = '';
              data.products.forEach(product => {
                html += `
                  <a href="${product.url}" class="flex items-center p-3 hover:bg-gray-50 transition-colors">
                    <div class="flex-shrink-0 w-12 h-12 mr-3">
                      ${product.image_url ? 
                        `<img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover rounded">` :
                        '<div class="w-full h-full bg-gray-200 rounded flex items-center justify-center text-gray-400 text-xs">No image</div>'
                      }
                    </div>
                    <div class="flex-grow">
                      <div class="font-medium text-gray-900">${product.name}</div>
                      <div class="text-sm text-gray-500">${product.category}</div>
                      <div class="text-sm font-bold text-brew-brown">${product.price}</div>
                    </div>
                  </a>
                `;
              });
              
              if (data.total_results > 5) {
                html += `
                  <div class="border-t border-gray-100 p-3 text-center">
                    <a href="/search?q=${encodeURIComponent(query)}" class="text-brew-brown hover:text-brew-dark font-medium">
                      View all ${data.total_results} results â†’
                    </a>
                  </div>
                `;
              }
              
              searchResultsContent.innerHTML = html;
              searchResults.classList.remove('hidden');
            } else {
              searchResultsContent.innerHTML = `
                <div class="p-3 text-gray-500 text-center">
                  No products found for "${query}"
                </div>
              `;
              searchResults.classList.remove('hidden');
            }
          })
          .catch(error => {
            console.error('Search error:', error);
            searchResults.classList.add('hidden');
          });
      }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(event) {
      if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
        searchResults.classList.add('hidden');
      }
    });
    
    // Show results when focusing on input (if there's content)
    searchInput.addEventListener('focus', function() {
      if (this.value.trim().length >= 2 && searchResultsContent.innerHTML.trim()) {
        searchResults.classList.remove('hidden');
      }
    });
  }
  
  // Mobile menu functionality
  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const openIcon = document.getElementById('menu-open-icon');
    const closeIcon = document.getElementById('menu-close-icon');
    const mobileSearchToggle = document.getElementById('mobile-search-toggle');
    const mobileSearch = document.getElementById('mobile-search');

    if (!button || !menu || !openIcon || !closeIcon) return;

    function toggleMenu(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const isHidden = menu.classList.contains('hidden');
      
      if (isHidden) {
        menu.classList.remove('hidden');
        openIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');
      } else {
        menu.classList.add('hidden');
        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      }
    }
    
    button.addEventListener('click', toggleMenu);
    
    // Mobile search toggle
    if (mobileSearchToggle && mobileSearch) {
      mobileSearchToggle.addEventListener('click', function() {
        mobileSearch.classList.toggle('hidden');
        if (!mobileSearch.classList.contains('hidden')) {
          const input = mobileSearch.querySelector('input');
          if (input) input.focus();
        }
      });
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!button.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('hidden');
        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      }
    });
  }

  // Desktop search functionality
  function initDesktopSearch() {
    const desktopSearchToggle = document.getElementById('desktop-search-toggle');
    const desktopSearch = document.getElementById('desktop-search');

    if (desktopSearchToggle && desktopSearch) {
      desktopSearchToggle.addEventListener('click', function () {
        desktopSearch.classList.toggle('hidden');
        if (!desktopSearch.classList.contains('hidden')) {
          const input = desktopSearch.querySelector('input');
          if (input) input.focus();
        }
      });

      // Close if you click outside
      document.addEventListener('click', function (e) {
        if (!desktopSearch.contains(e.target) && !desktopSearchToggle.contains(e.target)) {
          desktopSearch.classList.add('hidden');
        }
      });

      // Close with Escape key
      document.addEventListener('keydown', function (e) {
        if (e.key === "Escape") {
          desktopSearch.classList.add('hidden');
        }
      });
    }
  }

  // Initialize everything
  document.addEventListener('DOMContentLoaded', function() {
    initSearch();
    initMobileMenu();
    initDesktopSearch();
  });
  
  document.addEventListener('turbo:load', function() {
    initSearch();
    initMobileMenu();
    initDesktopSearch();
  });
  
  document.addEventListener('turbo:render', function() {
    initSearch();
    initMobileMenu();
    initDesktopSearch();
  });
</script>