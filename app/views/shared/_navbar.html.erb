<header class="sticky top-0 left-0 w-full bg-white shadow-sm z-50">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <!-- Logo -->
    <div class="flex items-center">
      <%= link_to root_path, class: "flex items-center space-x-2" do %>
        <span class="text-brew-brown text-2xl font-bold font-bebas">Bold Brew</span>
      <% end %>
    </div>

    <!-- Desktop Nav Links (centered) -->
    <nav class="hidden md:flex space-x-6 lg:space-x-8 text-sm font-medium items-center">
      <%= link_to "Home", root_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(root_path)}" %>
      <%= link_to "Shop", products_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(products_path)}" %>
      <%= link_to "About", about_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(about_path)}" %>
      <%= link_to "Contact", contact_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(contact_path)}" %>
      
      <% if user_signed_in? %>
        <% if current_user.orders.any? %>
          <%= link_to "Orders", orders_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200 #{'rounded-full py-2 px-4 bg-gray-100' if current_page?(orders_path)}" %>
        <% end %>
        <% if current_user.admin? %>
          <%= link_to "Products", admin_products_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200" %>
        <% end %>
      <% end %>
    </nav>
    
    <!-- User/Auth Links & Mobile Menu Button -->
    <div class="flex items-center space-x-4">
      <!-- Cart Link -->
      <%= link_to cart_path, class: "relative text-brew-dark hover:text-brew-brown transition-colors duration-200" do %>
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.182 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
      <% end %>

      <!-- User Profile Dropdown -->
      <% if user_signed_in? %>
        <div class="relative group hidden md:flex">
          <button class="flex items-center text-sm font-medium text-brew-dark hover:text-brew-brown focus:outline-none">
            <% if current_user.profile_picture.attached? %>
              <%= image_tag current_user.profile_picture.variant(resize_to_fill: [24, 24]), class: "h-6 w-6 rounded-full mr-2" %>
            <% else %>
              <div class="h-6 w-6 rounded-full mr-2 bg-gray-200 flex items-center justify-center text-gray-500">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/>
                </svg>
              </div>
            <% end %>
            <%= current_user.username.presence || current_user.email.split('@').first %>
            <svg class="ml-2 h-4 w-4 transition-transform duration-200 group-hover:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden group-hover:block transition-all duration-300 transform origin-top-right scale-95 opacity-0 group-hover:scale-100 group-hover:opacity-100">
            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
              <%= link_to 'My Profile', profile_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
              <%= link_to 'My Orders', orders_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>

              <% if current_user.admin? %>
                <div class="border-t border-gray-100 my-1"></div>
                <%= link_to 'Admin', admin_users_path, class: "block px-4 py-2 text-sm text-red-600 hover:bg-gray-100" %>
              <% end %>

              <div class="border-t border-gray-100 my-1"></div>
              <%= button_to 'Sign out', destroy_user_session_path, method: :delete, data: { turbo_confirm: "Are you sure you want to sign out?" }, class: "w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
            </div>
          </div>
        </div>
      <% else %>
        <div class="hidden md:flex items-center space-x-2">
          <%= link_to "Sign In", new_user_session_path, class: "text-brew-dark hover:text-brew-brown transition-colors duration-200" %>
        </div>
      <% end %>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-button" type="button" class="md:hidden text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-brew-brown" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <!-- Menu open icon -->
        <svg id="menu-open-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <!-- Menu close icon -->
        <svg id="menu-close-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1 bg-white border-t border-gray-200 shadow-lg">
      <%= link_to "Home", root_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(root_path)}" %>
      <%= link_to "Shop", products_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(products_path)}" %>
      <%= link_to "About", about_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(about_path)}" %>
      <%= link_to "Contact", contact_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(contact_path)}" %>
      
      <% if user_signed_in? %>
        <%= link_to "My Profile", profile_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(profile_path)}" %>
        <%= link_to "My Orders", orders_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(orders_path)}" %>
        <% if current_user.admin? %>
          <%= link_to "Admin", admin_users_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100 #{'bg-gray-100' if current_page?(admin_users_path)}" %>
        <% end %>
        <%= button_to "Sign out", destroy_user_session_path, method: :delete, data: { turbo_confirm: "Are you sure you want to sign out?" }, class: "block w-full text-left px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100" %>
      <% else %>
        <%= link_to "Sign In", new_user_session_path, class: "block px-3 py-2 rounded-md text-base font-medium text-brew-dark hover:bg-gray-100" %>
        <%= link_to "Sign Up", new_user_registration_path, class: "block px-3 py-2 rounded-md text-base font-medium text-white bg-brew-brown hover:bg-brew-dark" %>
      <% end %>
    </div>
  </div>
</header>

<script>
  // Use both DOMContentLoaded and turbo:load to ensure compatibility
  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const openIcon = document.getElementById('menu-open-icon');
    const closeIcon = document.getElementById('menu-close-icon');

    if (!button || !menu || !openIcon || !closeIcon) return;

    // Remove any existing event listeners
    button.removeEventListener('click', toggleMenu);
    
    function toggleMenu(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const isHidden = menu.classList.contains('hidden');
      
      if (isHidden) {
        // Show menu
        menu.classList.remove('hidden');
        openIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');
      } else {
        // Hide menu
        menu.classList.add('hidden');
        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      }
    }
    
    // Add event listener
    button.addEventListener('click', toggleMenu);

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!button.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('hidden');
        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      }
    });
  }

  // Initialize on both events
  document.addEventListener('DOMContentLoaded', initMobileMenu);
  document.addEventListener('turbo:load', initMobileMenu);
  document.addEventListener('turbo:render', initMobileMenu);
</script>